---
title: "hw6_vy2196"

output: github_document

---

```{r}
library(tidyverse)
library(broom)
library(purrr)
library(forcats)
```
### Problem 1
```{r}
homicides = read.csv("homicide_data.csv") |>
  janitor::clean_names() |>
  mutate(
    city_state = str_c(city, ", ", state),
    solved = if_else(disposition == "Closed by arrest", 1, 0),
    victim_age = as.numeric(victim_age)) |>
  # drop specific cities
  filter(
    !city_state %in% c("Dallas, TX", "Phoenix, AZ", 
                       "Kansas City, MO", "Tulsa, AL"),
    victim_race %in% c("White", "Black"))
```

```{r}
baltimore_dat = homicides |>
  filter(city_state == "Baltimore, MD")

fit_baltimore = glm(
  solved ~ victim_age + victim_sex + victim_race,
  data = baltimore_dat,
  family = binomial())

# adjusted OR and CI for male vs female (Baltimore)
baltimore_OR = tidy(
  fit_baltimore,
  exponentiate = TRUE,
  conf.int = TRUE) |>
  filter(term == "victim_sexMale") |>
  select(term, estimate, conf.low, conf.high)

baltimore_OR
```
In Baltimore, MD, the adjusted odds ratio for homicide resolution for male victims compared with female victims is 0.43 (95% CI: 0.32â€“0.56), indicating that, holding age and race constant, homicides involving male victims have substantially lower odds of being solved. The confidence interval excludes 1, suggesting this association is statistically significant.

```{r}
# Fit glm for each city
city_models = homicides |>
  group_by(city_state) |>
  nest() |>
  mutate(
    model = map(data,
      ~ glm(
        solved ~ victim_age + victim_sex + victim_race,
        data = .x,
        family = binomial())),
    tidied = map(
      model,
      ~ tidy(.x, exponentiate = TRUE, conf.int = TRUE))) |>
  select(city_state, tidied) |>
  unnest(tidied) |>
  filter(term == "victim_sexMale") |>
  ungroup() |>
  mutate(
    city_state = fct_reorder(city_state, estimate))

# check the first few rows of ORs and CIs by city
city_models |> select(city_state, estimate, conf.low, conf.high) |> head()

```


```{r}
# Plot ORs and CIs by city


ggplot(city_models, aes(x = city_state, y = estimate)) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.9) +
  geom_point(size = 2) +
  coord_flip() +
  labs(
    x = "City",
    y = "Adjusted Odds Ratio (Male vs Female)",
    title = "Adjusted Odds Ratios for Solving Homicides by City",
    subtitle = "Male vs Female victims, adjusted for age and race"
  )
```
Each point represents the adjusted odds ratio comparing the likelihood of solving homicides involving male victims to those involving female victims, while age and race remain constant. The horizontal bars represent 95% confidence intervals, and cities are ordered by their estimated ORs for easier comparison. An OR above 1 indicates higher odds of solving homicides of male victims, while an OR below 1 indicates lower odds.


